---
title: Moving your on-premise Octopus install to Azure. 
description: How to move your On-Premise Octopus deploy instance to a highly-available Azure configuration. 
author: derek.campbell@octopus.com
visibility: private
published: 2019-11-14
metaImage: image.png
bannerImage: image.png
tags:
 - Product
---

**TODO - Update image reference when received from Design**
![Image details](image.png)

All new Octopus licenses, from the 1st September 2019 support High Availability, meaning teams can run multiple Octopus servers, distributing load and tasks between them. In this post, Iâ€™m going to share how to move an on-prem Octopus Server instance to a highly available instance running in Azure.

!toc

## The Problem

Working as part of the Customer Success teams means we work with a range of customers from the smallest organizations using Octopus in a single [Space](https://octopus.com/docs/administration/spaces) to working with Global companies with diverse, distributed technical teams. These teams want to work with Octopus to deploy Infrastructure, Databases, and packaged applications. In today's cloud-first world, we see that these teams who scale their Octopus usage want to move their Octopus workload from On-Premise to Azure. An objective of this move is to ensure it is capable of high capacity, and fault-tolerant and High Availability is the best way to achieve this.

## The Solution

[High Availability](https://octopus.com/docs/administration/high-availability) enables you to run multiple Octopus Deploy Servers, distributing load and tasks between them. High Availability has several benefits which include:

* Higher resilience for business-critical workloads
* Simplifies maintenance tasks such as [server patching](https://en.wikipedia.org/wiki/Patch_(computing))
* Performance benefits
* Reducing cost

## On-Premise Infrastructure

Most organizations using Octopus, are hosting it in a single node configuration on a Virtual Machine hosted on a hypervisor with local storage, with some using Network Attached Storage or Storage Area Networks for Artifacts, Packages and Task Logs. It's typically hosted on a dedicated Virtual Machine listening over HTTP or HTTPS using a [LetsEncrypt](https://letsencrypt.org/) SSL certificate or an SSL certificate generated by a [Certificate Authority](https://en.wikipedia.org/wiki/Certificate_authority) or potentially even a [LetsEncrypt SSL Certificate](https://octopus.com/docs/administration/security/exposing-octopus/lets-encrypt-integration).

Unfortunately, [LetsEncrypt](https://letsencrypt.org/) SSL certificates are not supported automatically in a Highly-Available configuration, so if you are planning moving it to Azure, then you may need one from a [Certificate Authority](https://en.wikipedia.org/wiki/Certificate_authority).

If you're hosting on-Premise, you will likely have Octopus Configured under `C:\Octopus` or `D:\Octopus` with Logs, Artifacts, Packages and Task Logs hosted under folders locally or on a Network Attached Storage device.

Your on-premise setup probably looks something like:

**TODO - Add in Infrastructure diagram of different parts of Octopus.**

### Prep work

There is going to be some preparation required ahead of your move. It will require some time where Octopus is not going to be able to deploy, and you should organise a suitable downtime, as you should:

* Enable [Maintenance Mode](https://octopus.com/docs/administration/managing-infrastructure/maintenance-mode).
* [Drain all nodes.](https://octopus.com/docs/administration/high-availability/managing-high-availability-nodes#ManagingHighAvailabilityNodes-Drain)
* [Create a SQL Database backup.](https://octopus.com/docs/support/get-a-database-backup-and-encrypt-the-master-key#step-by-step-guide)
* Run a [backup](https://octopus.com/docs/administration/managing-infrastructure/server-configuration-and-file-storage#ServerconfigurationandFilestorage-FileStorageFilestorage) of your Artifacts, Packages, and Tasklogs and then copy these up to Azure. We would recommend zipping these up into a single compressed file.

### Enabling Maintenance Mode

The first thing to do would be to enable Maintenance Mode. In summary, Maintenance Mode enables you to safely prepare your server for maintenance, allowing existing tasks to complete, and preventing changes you didn't expect.

To enable Maintenance Mode, go to **Configuration > Maintenance**.

**TODO Create Image**
![Maintenance Mode Configuration](maintenance-mode.png)

Only users with the `Administer System` permission can enable/disable Maintenance Mode. Once Octopus is in Maintenance Mode:

* Users with the `Administer System` permission can still do anything they want, just like normal. All other users are prevented from making changes, which includes queuing new deployments or other tasks.
* The task queue will still be processed:
  * Tasks that were already running will run through to completion.
  * Tasks which were already queued (including [scheduled deployments](/docs/deployment-process/releases/index.md#scheduling-a-deployment)) will be started and run through to completion.
  * System tasks will still be queued and execute at their scheduled intervals. These kinds of tasks can be ignored since they are designed to be safe to cancel at any point in time.

### Enabling Node Drain

You also can stop all tasks from being executed on Octopus, and this becomes more useful if you're running Octopus in a Highly-Available configuration. Draining the nodes is helpful if you want to stop Octopus Administrators from running any tasks.

For each node, you need to do the following:

1. Go to **Configuration > Nodes** and put the node into drain mode.
1. Wait for any remaining Octopus Tasks on that node to complete.
1. Stop the Octopus Server windows service on that node.

At this point, your Octopus server is ready to be moved to Azure, and it will restore it in Azure with the nodes drained, and if you enabled Maintenance Mode, then it will also have Maintenance mode enabled.

![Drain nodes](nodedrain.png)

### Backup your Master Key

If you take one thing from this blog, please let it be this. **Backup, your Master Key**, then **back it up again**, and then lastly, **back it up once more**.

Octopus [encrypts important and sensitive data](/docs/administration/security/data-encryption.md) using a master key. If you lose your master key, then you would lose:

* The Octopus Server X.509 certificate which is used for [Octopus to Tentacle communication](/docs/administration/security/octopus-tentacle-communication/index.md) - this means your Tentacles won't trust your Octopus Server any more.
* Sensitive variable values, wherever you have defined them.
* Sensitive values in your deployment processes, like the password for a custom IIS App Pool user account.
* Sensitive values in your deployment targets, like the password for creating [Offline Drops](/docs/infrastructure/deployment-targets/offline-package-drop.md).

To see your Master Key, log on your Octopus Server, open up Octopus Server Manager and select View master key, and save this to your server as a text file and then back it up to a Password Manager much like [LastPass](http://lastpass.com/) or [KeyPass](https://keepass.info/).

![Master Key backup](masterkey.png)

### Proof of Concept vs. Production move

Generally, when doing something for the first time, we recommend running a Proof of Concept before trying it on your production instance of Octopus. You will need to decide whether you are doing this as a Proof of Concept or in Production ahead of time.

One approach would be to move your existing Octopus instance and get this working on Azure. After you get this working, you could add in high-availability by adding in a second node and a load balancer. You would need to have configured shared storage for Artifacts, Packages, and TaskLogs. The benefit of this approach is that it would likely involve less testing, and you can set it to be highly available once your Octopus instance in Azure has been tested and verified.

## Azure Architecture

*TODO Add Azure Infra Diagram**

### Octopus Virtual Machines

When creating a Highly-Available configuration, you are going to need to spin up a minimum of two Virtual Machines in Azure to host Octopus. We don't have a one-size-fits-all spec for Octopus as it will depend on:

* [Number and type of Deployment Targets](https://octopus.com/docs/administration/retention-policies/)
* [Retention Policies](https://octopus.com/docs/administration/retention-policies/)
* [Number of concurrent tasks](https://octopus.com/docs/support/increase-the-octopus-server-task-cap/)

If you have a reasonably small workload in Octopus, then you can probably go for a smaller Virtual Machine. Still, the Azure D Series Virtual Machines are a great place to start as they are for general purpose and fit most scenarios reasonably well. Our recommendation would be to consider your workload and then use one of the D Series VM's and see how well this performs for your requirements.

### SQL Database

Octopus is underpinned by a SQL Database that stores environments, projects, variables, releases, and deployment history. You will need to spin up a SQL server in Azure, and there are two options which you should consider, and these are:

* [SQL Server on a Virtual Machine](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-server-iaas-overview/)
* [Azure SQL Database as a Service](https://docs.microsoft.com/en-us/azure/sql-database/sql-database-technical-overview/)

Octopus natively works with both of these options, and we don't have a preference and will be a decision you will need to make. If you have access to a Database Administrator, then I would seek out their expertise on the matter as they may be able to provide further insight.

### SQL Virtual Machine vs. Azure SQL

I still see that most organizations are using Virtual Machines for when they are provisioning their SQL workload in the cloud, and in this section, I will go through the benefits of picking SQL VM's and some of the drawbacks.

As we are after a highly-available configuration Octopus, then we need to factor in high-availability at the SQL level. What this means is that you are going to need a minimum of 2 SQL servers, preferably in a [SQL cluster in Azure](https://techcommunity.microsoft.com/t5/Premier-Field-Engineering/Configure-SQL-Server-Failover-Cluster-Instance-on-Azure-Virtual/ba-p/371464), or an [Always On Availability Group](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-availability-group-tutorial) in Azure. For the most part, I am going to keep this part high-level as there is a lot of really great content on these topics out there already, and you may have a Database Administrator, who will carry this out for you. If you have this already on Azure, then I would recommend using that setup to host Octopus, preferably on a dedicated SQL instance.

There are several benefits of using SQL Virtual Machines over Azure SQL, and these are:

* Greater flexibility
* More control
* Hosting multiple Databases without additional cost.

Some of the drawbacks of using SQL Virtual Machines over Azure SQL:

* Higher Total Cost of Ownership
* Increased Setup time
* Maintaining Infrastructure and Database(s)

I spend a considerable amount of time doing Proof of Concepts, and I am a big fan of anything [PaaS](https://en.wikipedia.org/wiki/Platform_as_a_service). I particularly like [Azure SQL Database Service](https://docs.microsoft.com/en-us/azure/sql-database/sql-database-technical-overview), as I don't need to invest a considerable amount of time spinning up Virtual Machines's, Network Security Groups, Configuring SQL, Firewall rules, Maintenance plans and so forth. I can log on to the [Azure Portal](https://portal.azure.com/) and spin up a new SQL Server, Database, and connection strings in a matter of minutes and if you have [ARM Templates](https://azure.microsoft.com/en-gb/resources/templates/) in place for this, it can take seconds. [Infrastructure as Code](https://en.wikipedia.org/wiki/Infrastructure_as_code) is a huge time saver, but I realize that this may not be for everyone's preference just yet.

When spinning up a database on Azure SQL, I can create a geo-replicated or locally-replicated database in a few moments, and that's my DatabaseDatabase highly available. All I need to do now is configure the Connection string for Octopus, and I am good to go.

There are many benefits of using Azure SQL over SQL Virtual Machines:

* Easier to configure
* Spin up and tear down as you require in seconds/minutes
* Making the database highly-available is a couple of commands or clicks away.
* Managed Backup and Maintenance tasks.
* Great Azure AQL Analytics and Monitoring built-in.

Some of the drawbacks of using Azure SQL over SQL Virtual Machines:

* Less control
* Restoring Backups when something goes wrong, takes considerably longer.
* Refactoring SQL scripts
* Trying to understand what a [DTU](https://docs.microsoft.com/en-us/azure/sql-database/sql-database-service-tiers-dtu) is.

As you can see with both options, they have their merits and their drawbacks, and it's probably best if you give this some thought and pick the right solution for you and your Organizational needs.

### Storage

In a single node setup, you would typically host Octopus on [Local Storage](https://en.wikipedia.org/wiki/Local_storage) on either `C:\Octopus` or `D:\Octopus`. You're going to need some local storage for Octopus unless you decide to present an Azure File Share as a mapped drive or as a Symbolic link to the server. Our recommendation is to host your logs and configuration of Octopus locally on the server. It avoids any potential issues with accidentally pointing all of your Octopus nodes logs location to the same file, which would cause file locking issues and cause the Octopus server to stop until you resolved it.

### Artifacts, Packages & Task Logs

Octopus stores several files that are not suitable to store in the Database. These include:

* NuGet packages used by the [built-in NuGet repository](https://octopus.com/docs/packaging-applications/package-repositories) inside Octopus. These packages can often be substantial.
* Artifacts collected during a deployment. Teams using Octopus sometimes use this feature to collect large log files and other files from machines during a deployment.
* Task logs, which are text files that store all of the log output from deployments and other tasks.

As with the Database, from the Octopus perspective, you'll tell the Octopus Servers where to store them as a file path within your operating system. Octopus doesn't care what technology you use to present the shared storage; it could be a mapped network drive or a UNC path to a file share. Each of these three types of data is stored in a different place.

Whichever way you provide the shared storage, a few considerations to keep in mind:

* To Octopus, it needs to appear as a mapped network drive (e.g., `D:\`) or a UNC path to a file share (e.g., \\server\path)
* The service account that Octopus runs as needs full control over the directory
* Drives are mapped per-user, so you should assign the drive using the same service account that Octopus is running under

### Azure Files

If your Octopus Server is running in Microsoft Azure, there is only one solution unless you have a [DFS Replica](https://docs.microsoft.com/en-us/windows-server/storage/dfs-replication/dfsr-overview) in Azure. That solution is [Azure File Storage](https://docs.microsoft.com/en-us/azure/storage/files/storage-files-introduction) - it just presents a file share over SMB 3.0 that will is shared across all of your Octopus servers.

Once you have created your File Share, I find the best option is to add the Azure File Share as a [symbolic link](https://en.wikipedia.org/wiki/Symbolic_link) and then adding this in to `C:\Octopus\` for the Artifacts, Packages, and TaskLogs which need to be available to all nodes.

Run the below before installing Octopus.

````powershell
# Add the Authentication for the symbolic links. You can get this from the Azure Portal.

cmdkey /add:octostorage.file.core.windows.net /user:Azure\octostorage /pass:XXXXXXXXXXXXXX

# Add Octopus folder to add symbolic links

New-Item -ItemType directory -Path C:\Octopus
New-Item -ItemType directory -Path C:\Octopus\Artifacts
New-Item -ItemType directory -Path C:\Octopus\Packages
New-Item -ItemType directory -Path C:\Octopus\TaskLogs

# Add the Symbolic Links. Do this before installing Octopus.

mklink /D C:\Octopus\TaskLogs \\octostorage.file.core.windows.net\octoha\TaskLogs
mklink /D C:\Octopus\Artifacts \\octostorage.file.core.windows.net\octoha\Artifacts
mklink /D C:\Octopus\Packages \\octostorage.file.core.windows.net\octoha\Packages
````

[Install Octopus](https://octopus.com/docs/installation) and then run the below.

````powershell
# Set the path
& 'C:\Program Files\Octopus Deploy\Octopus\Octopus.Server.exe' path --artifacts "C:\Octopus\Artifacts"
& 'C:\Program Files\Octopus Deploy\Octopus\Octopus.Server.exe' path --taskLogs "C:\Octopus\TaskLogs"
& 'C:\Program Files\Octopus Deploy\Octopus\Octopus.Server.exe' path --nugetRepository "C:\Octopus\Packages"
````

### Load Balancer

This one took me a bit of time to make a selection as there are a few options for balancing your loads in Azure. It will depend entirely on your preference and what your Network team prefers, as are many options, and we are only listing a few of these below.

* [Azure Traffic Manager](https://docs.microsoft.com/en-us/azure/traffic-manager/traffic-manager-overview)
* [Azure Application Gateway](https://docs.microsoft.com/en-us/azure/application-gateway/overview)
* [Azure Load Balancer](https://docs.microsoft.com/en-us/azure/load-balancer/load-balancer-overview)
* [Kemp LoadMaster](https://kemptechnologies.com/uk/solutions/microsoft-load-balancing/loadmaster-azure/)
* [F5 Big-IP Virtual Edition](https://www.f5.com/partners/technology-alliances/microsoft-azure)

My preference after evaluating the options on Azure is the Azure Load Balancer option as this is a feature-rich

### Networking

Networking at the best of times is a contentious issue, and your configuration will depend heavily on your existing network topology and standards. I'd consider implementing one or some of the below to help protect your Azure workload:

* [Azure Bastion](https://azure.microsoft.com/en-gb/services/azure-bastion/)
* [VPN Gateway](https://azure.microsoft.com/en-gb/services/vpn-gateway/)
* [ExpressRoute](https://azure.microsoft.com/en-gb/services/expressroute/)
* [A Jump Box](https://en.wikipedia.org/wiki/Jump_server)

I'd look to use existing methods to connect to Azure if you already have this in place. If you have ExpressRoute, then this is the best approach, but much like with anything, it's the most expensive. If you have a VPN Gateway, or a jump box or even Azure Bastion service, then I would recommend using these to your advantage.

The biggest recommendation I can make here is to reduce your [surface of attack](https://en.wikipedia.org/wiki/Attack_surface) while keeping your networking as straight forward as you can without causing any potential security issues.

* Where possible, try and use [Internal IP's and networks](https://en.wikipedia.org/wiki/Private_network) over Public IP's, particularly for your SQL configuration.
* Use a VPN or a Jump/Bastion box. Preferably both.
* Secure Octopus to use HTTPS only with a valid certificate.

## Octopus post-move tasks

Once you have configured Octopus, we would recommend running some verification of the configuration.

### Disabling Maintenance Mode

To disable Maintenance Mode, go to **Configuration > Maintenance**. When maintenance mode is disabled, it will mean that Users can start deployments again, and we would recommend running some test deployments.

### Disabling Node Drain

Once you have disabled Maintenance Mode, then you will need to tell Octopus to run tasks again, and you do this for each node by doing the following:

1. Go to **Configuration > Nodes** and disable node drain.

## Tentacles

Most Organizations are using the Octopus Tentacle to deploy their applications, and there are some considerations here.

### Listening Tentacles

Listening Tentacles, for the most part, won't need any changes as the Octopus Server connects directly to the Tentacle. If you are connecting to the servers on-Premise, then you may need to set up [NAT rules](https://en.wikipedia.org/wiki/Network_address_translation) or a VPN or ExpressRoute to allow Octopus to communicate as it may have been using private IP's or DNS to connect.

### Polling Tentacles

Listening Tentacles require no special configuration for High Availability.  Polling Tentacles, however, poll a server at regular intervals to check if any tasks are waiting for the Tentacle to perform. In a High Availability scenario, Polling Tentacles must poll all of the Octopus Servers in your configuration. You could poll a load balancer, but there is a risk, depending on your load balancer configuration, that the Tentacle will not poll all servers promptly.  You could also configure the Tentacle to poll each server by registering it with one of your Octopus Servers and then adding each Octopus Server to the Tentacle.config file. There are two options to add Octopus Servers, via the command line or via editing the `Tentacle.config.` file directly:

Configuring the Tentacle via the command line is the preferred option with the command executed once per server, and it can be automated rather than doing each configuration manually, and an example command using the default instance is below:

```cmd
C:\Program Files\Octopus Deploy\Tentacle>Tentacle poll-server --server=http://Octopus.Company.com --apikey=API-77751F90F9EEDCEE0C0CD84F7A3CC726AD123FA6
```

For more information on this command, please check out the [Tentacle Poll Server options document](https://octopus.com/docs/octopus-rest-api/tentacle.exe-command-line/poll-server)

## Octopus verification

Once you have configured Octopus, we would recommend running some verification of the configuration.

## Resources

### Azure Checklist

A resource I find useful when provisioning Azure Infrastructure is the [Azure Checklist](http://azurechecklist.com/) as this contains almost everything you need to test and verify Azure Infrastructure.

## Summary

As you can see, there is quite a lot to consider when moving from On-Premise to Azure.
